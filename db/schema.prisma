// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "mongodb"
  url      = env("mongodb+srv://sivaiconicglobalsolution_db_user:Qp9QQd7m29trC3nk@siva.yp6tb0o.mongodb.net/juslegal")
}

generator client {
  provider = "prisma-client-js"
}

// --------------------------------------

model User {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  name           String?
  email          String   @unique
  hashedPassword String?
  role           String   @default("USER")
  updatedRole    Boolean  @default(false)

  tokens           Token[]
  sessions         Session[]
  Template         Template[]
  PDF              PDF[]
  TemplatePayment  TemplatePayment[]
  UserSubscription UserSubscription[]
}

model Session {
  id                 String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  expiresAt          DateTime?
  handle             String    @unique
  hashedSessionToken String?
  antiCSRFToken      String?
  publicData         String?
  privateData        String?

  user   User?   @relation(fields: [userId], references: [id])
  userId String? @db.ObjectId
}

model Token {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  hashedToken String
  type        String
  // See note below about TokenType enum
  // type        TokenType
  expiresAt   DateTime
  sentTo      String

  user   User   @relation(fields: [userId], references: [id])
  userId String @db.ObjectId

  @@unique([hashedToken, type])
}

model Template {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  name            String
  description     String
  total           String
  content         String
  placeholder     String?
  savedData       String?
  inputFields     String
  visibility      String
  user            User              @relation(fields: [userId], references: [id])
  userId          String            @db.ObjectId
  PDF             PDF[]
  Category        Category[]        @relation(fields: [categoryIds], references: [id])
  categoryIds     String[]          @db.ObjectId
  Subtemplate     Subtemplate[]
  TemplatePayment TemplatePayment[]
}

model Category {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  name        String     @unique
  Template    Template[] @relation(fields: [templateIds], references: [id])
  templateIds String[]   @db.ObjectId
}

model PDF {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  template      Template?    @relation(fields: [templateId], references: [id])
  templateId    String?      @db.ObjectId
  subtemplate   Subtemplate? @relation(fields: [subtemplateId], references: [id])
  subtemplateId String?      @db.ObjectId
  name          String
  // Store the PDF as a base64 encoded string
  content       String
  user          User         @relation(fields: [userId], references: [id])
  userId        String       @db.ObjectId

  @@unique([name, userId])
}

// NOTE: It's highly recommended to use an enum for the token type
//       but enums only work in Postgres.
//       See: https://blitzjs.com/docs/database-overview#switch-to-postgre-sql
// enum TokenType {
//   RESET_PASSWORD
// }

model Subtemplate {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  name            String
  description     String
  total           String
  content         String
  placeholder     String?
  inputFields     String
  template        Template          @relation(fields: [templateId], references: [id])
  templateId      String            @db.ObjectId
  TemplatePayment TemplatePayment[]
  PDF             PDF[]
}

model TemplatePayment {
  id                String       @id @default(auto()) @map("_id") @db.ObjectId
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  template          Template?    @relation(fields: [templateId], references: [id])
  templateId        String?      @db.ObjectId
  subtemplate       Subtemplate? @relation(fields: [subtemplateId], references: [id])
  subtemplateId     String?      @db.ObjectId
  status            String       @default("PENDING")
  user              User         @relation(fields: [userId], references: [id])
  userId            String       @db.ObjectId
  amount            BigInt
  currency          String
  razorpayOrderId   String?
  razorpayPaymentId String?
  razorpaySignature String?
}

model UserSubscription {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id])
  userId         String    @db.ObjectId
  customerId     String?
  subscriptionId String    @unique
  planId         String
  status         String    @default("CREATED")
  current_end    DateTime?
  end_at         DateTime?
}
